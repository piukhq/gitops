apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- github.com/kubernetes/ingress-nginx/deploy/static/provider/cloud?ref=controller-v1.9.4

namespace: ingress-nginx

replicas:
- count: 1
  name: ingress-nginx-controller

patches:
- path: patch-logging.yaml
- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: ingress-nginx-controller
      namespace: ingress-nginx
    spec:
      template:
        metadata:
          annotations:
            linkerd.io/inject: enabled
            config.linkerd.io/skip-inbound-ports: 80,443
            kubectl.kubernetes.io/default-container: controller
        spec:
          priorityClassName: bink-critical
          affinity:
            podAntiAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  podAffinityTerm:
                    labelSelector:
                      matchExpressions:
                        - key: app.kubernetes.io/name
                          operator: In
                          values:
                            - ingress-nginx
                        - key: app.kubernetes.io/component
                          operator: In
                          values:
                            - controller
                    topologyKey: topology.kubernetes.io/zone
  target:
    kind: Deployment
    name: ingress-nginx-controller
- patch: |-
    apiVersion: apps/v1
    kind: Service
    metadata:
      name: ingress-nginx-controller
      annotations:
        service.beta.kubernetes.io/azure-load-balancer-internal: "true"
        service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: /healthz
        service.beta.kubernetes.io/azure-pls-create: "true"
        service.beta.kubernetes.io/azure-pls-name: ${cluster_location}-${cluster_name}
        service.beta.kubernetes.io/azure-pls-ip-configuration-ip-address: ${cluster_pls_ip}
        service.beta.kubernetes.io/azure-pls-visibility: "*"
        service.beta.kubernetes.io/azure-pls-auto-approval: c1bc5dd7-ea97-469c-89fa-8f26624902fd
    spec:
      loadBalancerIP: ${cluster_lb_ip}
  target:
    kind: Service
    name: ingress-nginx-controller
- patch: |-
    - op: add
      path: /spec/template/spec/containers/0/args/-
      value: "--default-ssl-certificate=$(POD_NAMESPACE)/${cluster_name}.${cluster_location}.bink.sh"
  target:
    kind: Deployment
    name: ingress-nginx-controller
