apiVersion: batch/v1
kind: Job
metadata:
  name: hubble-migrator
  namespace: default
  labels:
    app: hubble
    component: migrator
spec:
  template:
    metadata:
      annotataions:
        linkerd.io/inject: enabled
        kubectl.kubernetes.io/default-container: app
      labels:
        app: hubble
        component: migrator
        azure.workload.identity/use: "true"
      spec:
        containers:
          - name: app
            image:  binkcore.azurecr.io/midas:latest
            command: ["linkerd-await", "--shutdown", "--"]
            args: ["bash", "-c", "alembic upgrade head; echo Done"]
            env: 
              - name: DATABASE_URI
                valueFrom:
                  secretKeyRef:
                    name: azure-postgres
                    key: url_placeholder
            resources:
              requests:
                memory: "384Mi"
              limits:
                memory: "384Mi"
            securityContext:
              runAsGroup: 65534
              runAsUser: 65534
            restartPolicy: Never
            serviceAccountName: hubble
            priorityClassName: bink-high-tasks
            imagePullSecrets:
              - name: binkcore.azurecr.io
      backoffLimit: 3
      