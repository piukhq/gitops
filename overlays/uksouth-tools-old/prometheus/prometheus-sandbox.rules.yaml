---
groups:
  - name: sandbox
    rules:
      # - alert: sandbox kube controller up state
      #   expr: (up{job="azure_node",name="sandbox-controller"} OR on() vector(0))
      #     < 1
      #   for: 5m
      #   labels:
      #     severity: S2
      #   annotations:
      #     resource: '{{ $labels.name }}'
      #     summary: Check virtual machine controller - bad up state for over 5 minutes

      # - alert: sandbox kube worker pool depleted
      #   expr: (sum(up{job="azure_node",name=~"sandbox-vmss_.+"}) OR on() vector(0))
      #     < 2
      #   for: 3m
      #   labels:
      #     severity: S2
      #   annotations:
      #     summary: Check sandbox cluster - worker count less than 2

      # - alert: sandbox kube worker up state
      #   expr: (up{job="azure_node",name=~"sandbox-vmss_.+"} OR on() vector(0)) <
      #     1
      #   for: 5m
      #   labels:
      #     severity: S2
      #   annotations:
      #     resource: '{{ $labels.name }}'
      #     summary: Check virtual machine worker - bad up state for over 5 minutes

      - alert: sandbox nginx ingress up state
        expr: (sum(up{kubernetes_cluster="sandbox",kubernetes_pod_name=~"ingress-nginx-controller.+"})
          OR on() vector(0)) < 2
        for: 3m
        labels:
          severity: S2
        annotations:
          resource: '{{ $labels.instance }}'
          summary: Check sandbox nginx ingress - bad upstate on one or more pods for
            over 3 minutes

  # - alert: sandbox oat rabbitmq up state
  #   expr: (sum(up{kubernetes_namespace="oat",kubernetes_pod_name=~"rabbitmq-\\d"}) OR on() vector(0)) < 1
  #   for: 3m
  #   labels:
  #     severity: S2
  #   annotations:
  #     resource: "{{ $labels.instance }}"
  #     summary: Check oat rabbitmq - bad upstate for over 3 minutes

      - alert: sandbox postgres cpu
        expr: cpu_percent_percent_max{resource_name="bink-uksouth-sandbox-common"}
          > 90
        for: 5m
        labels:
          severity: S2
        annotations:
          resource: '{{ $labels.resource_name }}'
          summary: Check sandbox postgres - CPU over 90% for 5 minutes

      - alert: sandbox postgres storage
        expr: storage_percent_percent_max{resource_name="bink-uksouth-sandbox-common"}
          > 90
        for: 5m
        labels:
          severity: S2
        annotations:
          resource: '{{ $labels.resource_name }}'
          summary: Check sandbox postgres - storage over 90% for 5 minutes

      - alert: sandbox postgres up state - direct
        expr: postgres_up_state{instance="bink-uksouth-sandbox"} < 1
        for: 3m
        labels:
          severity: S2
        annotations:
          resource: '{{ $labels.instance }}'
          summary: Check sandbox postgres flexible server - bad upstate for over 3
            minutes

      - alert: sandbox postgres up state - pgbouncer
        expr: pgbouncer_up_state{instance="bink-uksouth-sandbox"} < 1
        for: 3m
        labels:
          severity: S2
        annotations:
          resource: '{{ $labels.instance }}'
          summary: Check sandbox postgres flexible server pgbouncer - bad upstate
            for over 3 minutes

  # - alert: sandbox sit rabbitmq up state
  #   expr: (sum(up{kubernetes_namespace="sit",kubernetes_pod_name=~"rabbitmq-\\d"}) OR on() vector(0)) < 1
  #   for: 3m
  #   labels:
  #     severity: S2
  #   annotations:
  #     resource: "{{ $labels.instance }}"
  #     summary: Check sit rabbitmq - bad upstate for over 3 minutes

      # - alert: sandbox virtual machines cpu
      #   expr: 100 - (avg by (name) (irate(node_cpu_seconds_total{job="azure_node",name=~"sandbox-.+",mode="idle"}[5m]))
      #     * 100) > 90
      #   for: 5m
      #   labels:
      #     severity: S2
      #   annotations:
      #     resource: '{{ $labels.name }}'
      #     summary: Check virtual machine - CPU over 90% for over 5 minutes

      # - alert: sandbox virtual machines memory
      #   expr: node_memory_MemAvailable_bytes{job="azure_node",name=~"sandbox-.+"}
      #     < 100000000
      #   for: 5m
      #   labels:
      #     severity: S2
      #   annotations:
      #     resource: '{{ $labels.name }}'
      #     summary: Check virtual machine - Available memory < 100MB for over 5 minutes

      # - alert: sandbox virtual machines root filesystem
      #   expr: 100 - ((node_filesystem_avail_bytes{job="azure_node",name=~"sandbox-.+",mountpoint="/"}
      #     * 100) / node_filesystem_size_bytes{job="azure_node",name=~"sandbox-.+",mountpoint="/"})
      #     > 90
      #   for: 5m
      #   labels:
      #     severity: S2
      #   annotations:
      #     resource: '{{ $labels.name }}'
      #     summary: Check virtual machines - Root filesystem over 90% used for over
      #       5 minutes
