apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: app
        env:
        - name: FLUENT_ELASTICSEARCH_HOST
          value: elasticsearch.uksouth.bink.host
        - name: FLUENT_ELASTICSEARCH_PORT
          value: '9200'
        - name: FLUENT_ELASTICSEARCH_SCHEME
          value: https
        - name: FLUENT_ELASTICSEARCH_SSL_VERIFY
          value: 'false'
        - name: FLUENT_ELASTICSEARCH_USER
          valueFrom:
            secretKeyRef:
              key: ELASTICSEARCH_USER
              name: elasticsearch-auth
        - name: FLUENT_ELASTICSEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              key: ELASTICSEARCH_PASSWORD
              name: elasticsearch-auth
        - name: FLUENT_KUBERNETES_ENV
          value: prod
        - name: FLUENT_KUBERNETES_CLUSTER
          value: ${cluster_name}
        - name: FLUENTD_SYSTEMD_CONF
          value: disable
        - name: FLUENT_CONTAINER_TAIL_PARSER_TYPE
          value: /^(?<time>.+) (?<stream>stdout|stderr) [^ ]* (?<log>.*)$/
        - name: FLUENT_ELASTICSEARCH_LOG_ES_400_REASON
          value: 'true'
