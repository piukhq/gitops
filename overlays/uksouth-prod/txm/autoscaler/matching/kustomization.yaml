apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - github.com/cpressland/rq-autoscaler/deploy
nameSuffix: -matching
commonLabels:
  app: rq-autoscaler
  queue: matching
patches:
  - target:
      kind: CronJob
    patch: |
      - op: add
        path: /spec/jobTemplate/spec/template/metadata/annotations/linkerd.io~1inject
        value: disabled
  - target:
      kind: CronJob
    patch: |
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/containers/0/env
        value:
          - name: REDIS_URL
            valueFrom:
              secretKeyRef:
                name: azure-redis
                key: url_primary
          - name: DEPLOYMENT
            value: txm/harmonia-matching-worker
          - name: QUEUE
            value: matching
          - name: MIN_REPLICAS
            value: "1"
          - name: MAX_REPLICAS
            value: "70"
          - name: TASKS_PER_REPLICA
            value: "10000"
