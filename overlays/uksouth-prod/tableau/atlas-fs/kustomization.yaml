bases:
  - github.com/binkhq/postgres-to-postgres/deploy

namespace: tableau

patches:
  - target:
      kind: Deployment
    patch: |-
      - op: add
        path: /metadata/annotations/buoyant.cloud~1excluded
        value: "true"
  - target:
      kind: CronJob
    patch: |-
      - op: replace
        path: /metadata/name
        value: atlas-sync-fs
  - target:
      kind: CronJob
    patch: |-
      - op: replace
        path: /spec/schedule
        value: "0 2 * * *"
  - target:
      kind: CronJob
    patch: |-
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/containers/0/env
        value:
          - name: source_psql_connection_string
            valueFrom:
              secretKeyRef:
                key: common_atlas
                name: azure-pgfs
          - name: destination_psql_connection_string
            valueFrom:
              secretKeyRef:
                key: tableau_postgres
                name: azure-pgfs
          - name: destination_is_single_server
            value: 'false'
          - name: redis_url
            valueFrom:
              secretKeyRef:
                key: uri_ssl
                name: azure-redis-vnet
          - name: leader_election_enabled
            value: 'true'
          - name: extra_dump_args
            value: --table transactions_*
