[transforms.dedot_labels]
type = "lua"
inputs = ["kubernetes_logs"]
version = "2"

source = """
function process(event, emit)
    if event.log.kubernetes == nil then
        return
    end
    dedot(event.log.kubernetes.pod_labels)
    emit(event)
end

function dedot(map)
    if map == nil then
        return
    end
    local new_map = {}
    local changed_keys = {}
    for k, v in pairs(map) do
        local dedotted = string.gsub(k, "%.", "_")
        if dedotted ~= k then
            new_map[dedotted] = v
            changed_keys[k] = true
        end
    end
    for k in pairs(changed_keys) do
        map[k] = nil
    end
    for k, v in pairs(new_map) do
        map[k] = v
    end
end
"""
[transforms.dedot_labels.hooks]
process = "process"

[sinks.elasticsearch]
type = "elasticsearch"
inputs = ["dedot_labels"]
compression = "none"
healthcheck = true
endpoint = "https://opensearch.uksouth.bink.host:9200"
[sinks.elasticsearch.tls]
ca_file = "/opensearch/opensearch-ca.pem"
[sinks.elasticsearch.auth]
strategy = "basic"
user = "vector"
password = "4iBEQ4dJ3d!d4JDXi77L!cmzwjkv2gb!"
[sinks.elasticsearch.bulk]
index = "vector-sandbox-%F"
