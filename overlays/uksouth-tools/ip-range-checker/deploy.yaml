---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: ip-range-checker
  name: ip-range-checker
  namespace: default
spec:
  progressDeadlineSeconds: 120
  replicas: 1
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app: ip-range-checker
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: ip-range-checker
    spec:
      initContainers:
        - name: chown
          command: [chown, -R, 1000:1000, /elasticsearch]
          image: docker.io/alpine:3
          volumeMounts:
            - name: elasticsearch
              mountPath: /elasticsearch
      containers:
        - image: binkcore.azurecr.io/ip_range_checker:latest
          name: app
          imagePullPolicy: Always
          resources:
            limits:
              memory: 128Mi
            requests:
              cpu: 100m
              memory: 128Mi
        - name: elasticsearch
          image: docker.io/elasticsearch:7.17.6
          env:
            - name: discovery.type
              value: single-node
          ports:
            - name: elastic
              containerPort: 9200
          resources:
            requests:
              cpu: 1000m
              memory: 1024Mi
            limits:
              memory: 1024Mi
          volumeMounts:
            - name: elasticsearch
              mountPath: /usr/share/elasticsearch/data
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      imagePullSecrets:
        - name: binkcore.azurecr.io
      volumes:
        - name: elasticsearch
          persistentVolumeClaim:
            claimName: ip-range-checker-elasticsearch-data
