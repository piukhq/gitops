---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mimir
  namespace: mimir
spec:
  chart:
    spec:
      chart: mimir-distributed
      version: 2.1.0
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  interval: 60m
  values:
    minio:
      enabled: false
    distributor:
      replicas: 3
    ingester:
      persistentVolume:
        size: 100Gi
    nginx:
      replicas: 3
      ingress:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: nginx
          nginx.ingress.kubernetes.io/service-upstream: 'true'
          # nginx.ingress.kubernetes.io/whitelist-source-range: 10.0.0.0/8,192.168.1.0/24,192.168.101.0/24,192.168.102.0/24,192.168.20.0/24,192.168.22.0/24,192.168.23.0/24,192.168.4.0/24
        hosts:
          - host: mimir.${cluster_name}.${location}.bink.host
            paths:
              - path: /
                pathType: Prefix
        tls:
          - secretName: mimir.${cluster_name}.${location}.bink.host
            hosts:
              - mimir.${cluster_name}.${location}.bink.host
      basicAuth:
        enabled: true
        username: 27b30688-89e6-4ee6-93d9-de889399db57
        password: 547c5d39-f771-4a87-8ec6-afe4953ff541
    mimir:
      config: |-
        multitenancy_enabled: false

        limits:
          max_global_series_per_user: 1000000
          max_global_series_per_metric: 1000000
          ingestion_rate: 100000

        activity_tracker:
          filepath: /data/metrics-activity.log

        alertmanager:
          data_dir: '/data'
          enable_api: true
          external_url: '/alertmanager'


        alertmanager_storage:
          backend: azure
          azure:
            account_name: binkuksouthtools
            account_key: 1kyRDOG27i+tS5uRaPJuD0vkroaEQMj3NO+Ho52GnUS1XyagEqVjkXGMCqzYgg9X+b1nAPNBwupU5oLvuZTMxw==
            container_name: mimir-alertmanager

        frontend_worker:
          frontend_address: {{ template "mimir.fullname" . }}-query-frontend-headless.{{ .Release.Namespace }}.svc:{{ include "mimir.serverGrpcListenPort" . }}

        ruler:
          enable_api: true
          rule_path: '/data'
          alertmanager_url: dnssrvnoa+http://_http-metrics._tcp.{{ template "mimir.fullname" . }}-alertmanager-headless.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}/alertmanager

        server:
          grpc_server_max_recv_msg_size: 104857600
          grpc_server_max_send_msg_size: 104857600
          grpc_server_max_concurrent_streams: 1000

        frontend:
          log_queries_longer_than: 10s
          align_queries_with_step: true

        compactor:
          data_dir: "/data"

        ingester:
          ring:
            final_sleep: 0s
            num_tokens: 512

        ingester_client:
          grpc_client_config:
            max_recv_msg_size: 104857600
            max_send_msg_size: 104857600

        runtime_config:
          file: /var/{{ include "mimir.name" . }}/runtime.yaml

        memberlist:
          abort_if_cluster_join_fails: false
          compression_enabled: false
          join_members:
          - {{ include "mimir.fullname" . }}-gossip-ring

        blocks_storage:
          backend: azure
          tsdb:
            dir: /data/tsdb
          bucket_store:
            sync_dir: /data/tsdb-sync
          azure:
            account_name: binkuksouthtools
            account_key: 1kyRDOG27i+tS5uRaPJuD0vkroaEQMj3NO+Ho52GnUS1XyagEqVjkXGMCqzYgg9X+b1nAPNBwupU5oLvuZTMxw==
            container_name: mimir-blocks

        ruler_storage:
          backend: azure
          azure:
            account_name: binkuksouthtools
            account_key: 1kyRDOG27i+tS5uRaPJuD0vkroaEQMj3NO+Ho52GnUS1XyagEqVjkXGMCqzYgg9X+b1nAPNBwupU5oLvuZTMxw==
            container_name: mimir-admin
