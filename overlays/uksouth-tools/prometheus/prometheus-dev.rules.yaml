groups:
- name: dev
  rules:
  - alert: dev kube controller up state
    expr: (up{job="azure_node",name="dev0-controller"} OR on() vector(0)) < 1
    for: 5m
    labels:
      severity: S3
    annotations:
      resource: "{{ $labels.name }}"
      summary: Check virtual machine controller - bad up state for over 5 minutes

  - alert: dev kube worker pool depleted
    expr: (sum(up{job="azure_node",name=~"dev0-vmss_.+"}) OR on() vector(0)) < 2
    for: 3m
    labels:
      severity: S3
    annotations:
      summary: Check dev0 cluster - worker count less than 2
      
  - alert: dev kube worker up state
    expr: (up{job="azure_node",name=~"dev0-vmss_.+"} OR on() vector(0)) < 1
    for: 5m
    labels:
      severity: S3
    annotations:
      resource: "{{ $labels.name }}"
      summary: Check virtual machine worker - bad up state for over 5 minutes

  - alert: dev nginx ingress up state
    expr: (sum(up{kubernetes_cluster="dev0",kubernetes_pod_name=~"ingress-nginx-controller.+"}) OR on() vector(0)) < 2
    for: 3m
    labels:
      severity: S3
    annotations:
      resource: "{{ $labels.instance }}"
      summary: Check dev nginx ingress - bad upstate on one or more pods for over 3 minutes

  - alert: dev postgres active connections
    expr: (active_connections_count_average{resource_name="bink-uksouth-dev"} OR on() vector(0)) < 1
    for: 5m
    labels:
      severity: S3
    annotations:
      resource: "{{ $labels.resource_name }}"
      summary: "Check Postgres {{ $labels.resource_name }}, reporting no current active connections"

  - alert: dev postgres cpu
    expr: cpu_percent_percent_max{resource_group="uksouth-dev",resource_name="bink-uksouth-dev-common"} > 90
    for: 5m
    labels:
      severity: S3
    annotations:
      resource: "{{ $labels.resource_name }}"
      summary: Check dev postgres - CPU over 90% for 5 minutes

  - alert: dev postgres storage
    expr: storage_percent_percent_max{resource_group="uksouth-dev",resource_name="bink-uksouth-dev-common"} > 90
    for: 5m
    labels:
      severity: S3
    annotations:
      resource: "{{ $labels.resource_name }}"
      summary: Check dev postgres - storage over 90% for 5 minutes

  - alert: dev postgres up state - direct
    expr: postgres_up_state{instance="bink-uksouth-dev"} < 1
    for: 3m
    labels:
      severity: S3
    annotations:
      resource: "{{ $labels.instance }}"
      summary: Check dev postgres flexible server - bad upstate for over 3 minutes
      
  - alert: dev postgres up state - pgbouncer
    expr: pgbouncer_up_state{instance="bink-uksouth-dev"} < 1
    for: 3m
    labels:
      severity: S3
    annotations:
      resource: "{{ $labels.instance }}"
      summary: Check dev postgres flexible server pgbouncer - bad upstate for over 3 minutes

#   - alert: dev postgres up state
#     expr: (up{instance="bink-uksouth-dev-common",job="postgres"} OR on() vector(0)) < 1
#     for: 3m
#     labels:
#       severity: S3
#     annotations:
#       resource: "{{ $labels.instance }}"
#       summary: Check dev postgres - bad upstate for over 3 minutes

  - alert: dev redis up state
    expr: (redis_up{instance="bink-uksouth-dev0"} OR on() vector(0)) < 1
    for: 3m
    labels:
      severity: S3
    annotations:
      resource: "{{ $labels.instance }}"
      summary: Check dev redis - bad upstate for over 3 minutes
      
  # - alert: dev rabbitmq up state
  #   expr: (sum(up{kubernetes_cluster="dev0",kubernetes_pod_name=~"rabbitmq-\\d"}) OR on() vector(0)) < 1
  #   for: 3m
  #   labels:
  #     severity: S3
  #   annotations:
  #     resource: "{{ $labels.instance }}"
  #     summary: Check dev rabbitmq - bad upstate for over 3 minutes

  - alert: dev virtual machines cpu
    expr: 100 - (avg by (name) (irate(node_cpu_seconds_total{job="azure_node",name=~"dev0-.+",mode="idle"}[5m])) * 100) > 90
    for: 5m
    labels:
      severity: S3
    annotations:
      resource: "{{ $labels.name }}"
      summary: Check virtual machine - CPU over 90% for over 5 minutes

  - alert: dev virtual machines memory
    expr: node_memory_MemAvailable_bytes{job="azure_node",name=~"dev0-.+"} < 100000000
    for: 5m
    labels:
      severity: S3
    annotations:
      resource: "{{ $labels.name }}"
      summary: Check virtual machine - Available memory < 100MB for over 5 minutes

  - alert: dev virtual machines root filesystem
    expr: 100 - ((node_filesystem_avail_bytes{job="azure_node",name=~"dev0-.+",mountpoint="/"} * 100) / node_filesystem_size_bytes{job="azure_node",name=~"dev0-.+",mountpoint="/"}) > 90
    for: 5m
    labels:
      severity: S3
    annotations:
      resource: "{{ $labels.name }}"
      summary: Check virtual machines - Root filesystem over 90% used for over 5 minutes


