---
groups:
  - name: Infrastructure
    rules:
      - alert: Unavailable Replicas
        expr: sum by(deployment, namespace) (kube_deployment_status_replicas_unavailable) > 0
        for: 1m
        labels:
          severity: p2
          cluster: Staging
          component: Kubernetes
          resolve: true
        annotations:
          title: 'Staging - {{ $labels.deployment}}'
          description: 'Deployment: {{ $labels.deployment}} in Namespace: {{$labels.namespace}} has unavailable replicas.'

      - alert: Container Restarts
        expr: increase(kube_pod_container_status_restarts_total{namespace!="kube-system"}[5m]) > 0
        for: 1s
        labels:
          severity: p2
          cluster: staging
          component: Kubernetes
        annotations:
          title: 'Staging - Container restarts'
          description: 'Container: {{$labels.container}} in Deploy: {{$labels.pod}} in Namespace: {{$labels.namespace}} is restarting alot'
      
      - alert: Kube pod waiting status
        expr: sum by (reason, pod)(kube_pod_container_status_waiting_reason) > 0
        for: 1m
        labels: 
          severity: p2
          cluster: staging
          component: Kubernetes
          resolve: true
        annotations:  
          title: 'Staging - Pod waiting status'
          description: 'Pod: {{$labels.pod}} is in this State: {{$labels.reason}} in this Namespace: {{$labels.namespace}}'

      - alert: Kube pod status
        expr: kube_pod_status_phase{phase=~"Failed|Unknown"} > 0
        for: 1m
        labels:
          severity: p2
          cluster: staging
          component: Kubernetes
          resolve: true
        annotations: 
          title: 'Staging - Pods in failed or unknown phase'
          description: 'Pod: {{$labels.pod}} is in State: {{$labels.phase}}'
      # - alert: core sftp up state
      #   expr: up{job="azure_node",name=~"sftp\\d"} < 1
      #   for: 3m
      #   labels:
      #     severity: S1
      #   annotations:
      #     resource: '{{ $labels.name }}'
      #     summary: Check sftp virtual machines - bad up state for over 3 minutes
