---
bases:
  - ../../default/api-reflector

namespace: trusted-channels

patches:
  - target:
      kind: Deployment
    patch: |-
      - op: remove
        path: /spec/template/spec/containers/0/env
  - target:
      kind: Deployment
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: api-reflector
      spec:
        template:
          spec:
            containers:
              - name: app
                envFrom:
                  - configMapRef:
                      name: api-reflector
                env:
                  - name: postgres_dsn
                    value: postgresql://postgres@postgres:5432/api-reflector

patchesStrategicMerge:
  - |-
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: reflector.${cluster_name}.${location}.bink.sh
    $patch: delete
  - |-
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: reflector.${cluster_name}.${location}.bink.sh
    $patch: delete
  - |-
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: reflector.${cluster_name}.${location}.bink.sh-healthz
    $patch: delete
