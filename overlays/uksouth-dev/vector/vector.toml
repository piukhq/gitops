[sinks.loganalytics]
type = "azure_monitor_logs"
inputs = ["kubernetes_logs"]
azure_resource_id = "/subscriptions/0add5c8e-50a6-4821-be0f-7a47c879b009/resourcegroups/uksouth-loganalytics/providers/microsoft.operationalinsights/workspaces/uksouth-loganalytics"
customer_id = "eed2b98d-3396-4972-be3e-3e744532f7cd"
host = "ods.opinsights.azure.com"
log_type = "kubernetes_dev"
shared_key = "p6KTG57eZlZ9usb2A4V3/3Ey8tPJBo6WG5+HNELFgwuuEWLH7yciDyqPdbtAWJwcjF2urH1SiYwaX8zz78/Q0g=="

[transforms.dedot_labels]
type = "lua"
inputs = ["kubernetes_logs"]
version = "2"

source = """
function process(event, emit)
    if event.log.kubernetes == nil then
        return
    end
    dedot(event.log.kubernetes.pod_labels)
    emit(event)
end

function dedot(map)
    if map == nil then
        return
    end
    local new_map = {}
    local changed_keys = {}
    for k, v in pairs(map) do
        local dedotted = string.gsub(k, "%.", "_")
        if dedotted ~= k then
            new_map[dedotted] = v
            changed_keys[k] = true
        end
    end
    for k in pairs(changed_keys) do
        map[k] = nil
    end
    for k, v in pairs(new_map) do
        map[k] = v
    end
end
"""
[transforms.dedot_labels.hooks]
process = "process"

[sinks.elasticsearch]
type = "elasticsearch"
inputs = ["dedot_labels"]
compression = "none"
healthcheck = true
endpoint = "https://opensearch.uksouth.bink.host:9200"
[sinks.elasticsearch.tls]
ca_file = "/opensearch/opensearch-ca.pem"
[sinks.elasticsearch.auth]
strategy = "basic"
user = "vector"
password = "4iBEQ4dJ3d!d4JDXi77L!cmzwjkv2gb!"
[sinks.elasticsearch.bulk]
index = "vector-dev-%F"
