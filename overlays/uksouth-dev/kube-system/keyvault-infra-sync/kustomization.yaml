---
bases:
  - github.com/terrycain/keyvault2kube/deploy?ref=2.1.0

configMapGenerator:
  - name: keyvault-infra-sync
    namespace: kube-system
    files:
      - config/pgbouncer.yaml

patches:
  - target:
      kind: Deployment
    patch: |-
      - op: replace
        path: /metadata/name
        value: keyvault-infra-sync
  - target:
      kind: Deployment
    patch: |-
      - op: replace
        path: /spec/template/metadata/labels/aadpodidbinding
        value: keyvault-infra-sync
  - target:
      kind: Deployment
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: KEY_VAULT_URLS
            value: https://bink-uksouth-dev-inf.vault.azure.net/
  - target:
      kind: Deployment
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - mountPath: /app/templates
            name: template-config
  - target:
      kind: Deployment
    patch: |-
      - op: replace
        path: /spec/template/spec/volumes
        value:
          - name: template-config
            configMap:
              defaultMode: 420
              name: keyvault-infra-sync
  - target:
      kind: AzureIdentity
    patch: |-
      - op: replace
        path: /spec/resourceID
        value: /subscriptions/794aa787-ec6a-40dd-ba82-0ad64ed51639/resourceGroups/uksouth-dev/providers/Microsoft.ManagedIdentity/userAssignedIdentities/bink-uksouth-dev-infra-sync
  - target:
      kind: AzureIdentity
    patch: |-
      - op: replace
        path: /spec/clientID
        value: a4e207e6-9d04-4a47-937d-a2bc32a18c00
  - target:
      kind: AzureIdentity
    patch: |-
      - op: replace
        path: /metadata/name
        value: keyvault-infra-sync
  - target:
      kind: AzureIdentityBinding
    patch: |-
      - op: replace
        path: /metadata/name
        value: keyvault-infra-sync
  - target:
      kind: AzureIdentityBinding
    patch: |-
      - op: replace
        path: /spec/azureIdentity
        value: keyvault-infra-sync
  - target:
      kind: AzureIdentityBinding
    patch: |-
      - op: replace
        path: /spec/selector
        value: keyvault-infra-sync
